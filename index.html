<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Division Estimating Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --bg-input: #0d1320;
            --border-color: #2a3548;
            --border-highlight: #3b4d6b;
            --text-primary: #e8edf5;
            --text-secondary: #9ca8bc;
            --text-muted: #6b7a94;
            --accent-red: #ef5350;
            --accent-red-dim: #c62828;
            --accent-yellow: #fdd835;
            --accent-yellow-dim: #f9a825;
            --accent-purple: #ab47bc;
            --accent-purple-dim: #7b1fa2;
            --accent-pink: #f06292;
            --accent-pink-dim: #c2185b;
            --accent-blue: #42a5f5;
            --accent-blue-dim: #1565c0;
            --accent-green: #66bb6a;
            --accent-green-dim: #2e7d32;
            --accent-orange: #ffa726;
            --accent-cyan: #26c6da;
            --accent-teal: #26a69a;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;
            padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon {
            width: 42px; height: 42px;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.3rem; color: var(--bg-primary);
        }
        .logo-text h1 { font-size: 1.2rem; font-weight: 700; letter-spacing: -0.025em; }
        .logo-text span { font-size: 0.72rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .header-controls { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; }
        .btn {
            padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer;
            font-weight: 600; font-size: 0.85rem; transition: all 0.2s ease;
            font-family: inherit; display: inline-flex; align-items: center; gap: 0.4rem;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dim)); color: white; box-shadow: 0 2px 8px rgba(66,165,245,0.3); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(66,165,245,0.4); }
        .btn-success { background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dim)); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--accent-red), var(--accent-red-dim)); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-small { padding: 0.35rem 0.75rem; font-size: 0.75rem; }
        .project-info {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 1rem; margin-bottom: 1rem;
            display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
        }
        .project-info label { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .project-info input {
            flex: 1; min-width: 250px; padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color); border-radius: 4px;
            background: var(--bg-input); color: var(--text-primary); font-size: 1rem; font-weight: 600;
        }
        .project-info input:focus { outline: none; border-color: var(--accent-orange); }
        .settings-panel {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 1rem; margin-bottom: 1rem;
        }
        .settings-row { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-end; }
        .setting-group { display: flex; flex-direction: column; gap: 0.35rem; }
        .setting-group label {
            font-size: 0.72rem; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .setting-group input, .setting-group select {
            padding: 0.5rem 0.75rem; border: 1px solid var(--border-color);
            border-radius: 4px; background: var(--bg-input); color: var(--text-primary);
            font-size: 0.85rem; min-width: 110px; font-family: 'JetBrains Mono', monospace;
        }
        .setting-group input:focus, .setting-group select:focus { outline: none; border-color: var(--accent-blue); }
        .panel-wrapper { margin-bottom: 0.75rem; }
        .panel-toggle {
            width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 0.65rem 1rem; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--text-primary); font-weight: 600; font-size: 0.85rem;
            transition: all 0.2s ease; font-family: inherit;
        }
        .panel-toggle:hover { background: var(--bg-tertiary); }
        .panel-toggle .arrow { transition: transform 0.3s ease; font-size: 1rem; }
        .panel-toggle.open { border-radius: 8px 8px 0 0; }
        .panel-toggle.open .arrow { transform: rotate(180deg); }
        .panel-toggle .toggle-left { display: flex; align-items: center; gap: 0.75rem; }
        .panel-toggle .toggle-left input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent-orange); }
        .panel-content {
            display: none; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-top: none; border-radius: 0 0 8px 8px; padding: 1.25rem;
        }
        .panel-content.open { display: block; }
        .panel-toggle.disabled-look { opacity: 0.5; }
        .wt-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .wt-grid-wide { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .input-group { margin-bottom: 0.65rem; }
        .input-group:last-child { margin-bottom: 0; }
        .input-group label {
            display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-secondary);
            margin-bottom: 0.2rem; text-transform: uppercase;
        }
        .input-group .hint { font-size: 0.6rem; color: var(--text-muted); margin-bottom: 0.2rem; font-style: italic; text-transform: none; }
        .input-group input, .input-group select {
            width: 100%; padding: 0.45rem 0.6rem; border: 1px solid var(--border-color);
            border-radius: 4px; background: var(--bg-input); color: var(--text-primary);
            font-size: 0.8rem; font-family: 'JetBrains Mono', monospace;
        }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(66,165,245,0.15); }
        .input-group input::placeholder { color: var(--text-muted); }
        .output-section {
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 0.75rem; margin-top: 1rem;
        }
        .output-section h5 {
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--accent-cyan); margin-bottom: 0.5rem; padding-bottom: 0.35rem;
            border-bottom: 1px solid var(--border-color);
        }
        .output-row { display: flex; justify-content: space-between; align-items: center; padding: 0.15rem 0; font-size: 0.75rem; }
        .output-row .lbl { color: var(--text-secondary); }
        .output-row .val { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--text-primary); }
        .output-row.highlight .val { color: var(--accent-cyan); }
        .output-row.cost .val { color: var(--accent-green); }
        .output-divider { border-top: 1px dashed var(--border-color); margin: 0.3rem 0; }

        /* Three-Tier Output Table */
        .tier-table { width: 100%; border-collapse: collapse; font-size: 0.72rem; margin-top: 0.5rem; }
        .tier-table th {
            text-align: center; padding: 0.35rem 0.4rem; font-size: 0.62rem;
            text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted);
            border-bottom: 1px solid var(--border-color); font-weight: 600;
        }
        .tier-table th:first-child { text-align: left; }
        .tier-table td { padding: 0.35rem 0.4rem; text-align: center; font-family: 'JetBrains Mono', monospace; font-weight: 500; border-bottom: 1px solid var(--border-color); }
        .tier-table td:first-child { text-align: left; font-family: 'IBM Plex Sans', sans-serif; font-weight: 600; }
        .tier-table .tier-cons td:first-child { color: var(--accent-orange); }
        .tier-table .tier-std td:first-child { color: var(--accent-cyan); }
        .tier-table .tier-agg td:first-child { color: var(--accent-green); }
        .tier-table .tier-std { background: rgba(38, 198, 218, 0.06); }

        /* Striping Table */
        .stripe-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; margin-top: 0.5rem; }
        .stripe-table th {
            text-align: left; padding: 0.4rem 0.5rem; font-size: 0.65rem;
            text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);
            border-bottom: 1px solid var(--border-color); font-weight: 600;
        }
        .stripe-table td { padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--border-color); }
        .stripe-table input {
            width: 80px; padding: 0.3rem 0.5rem; border: 1px solid var(--border-color);
            border-radius: 4px; background: var(--bg-input); color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; text-align: right;
        }
        .stripe-table input:focus { outline: none; border-color: var(--accent-blue); }
        .stripe-table .unit { color: var(--text-muted); font-size: 0.7rem; }
        .stripe-table .calc-val { font-family: 'JetBrains Mono', monospace; color: var(--text-primary); font-weight: 600; }
        .stripe-table .machine-row { border-left: 3px solid var(--accent-blue); }
        .stripe-table .hand-row { border-left: 3px solid var(--accent-yellow); }

        /* Cost Summary */
        .cost-summary {
            background: var(--bg-secondary); border: 2px solid var(--accent-green);
            border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;
        }
        .cost-summary h2 {
            font-size: 1.1rem; font-weight: 700; color: var(--accent-green);
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);
        }
        .cost-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.25rem; }
        .cost-category {
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 1rem;
        }
        .cost-category h4 {
            font-size: 0.78rem; font-weight: 700; color: var(--accent-cyan);
            text-transform: uppercase; margin-bottom: 0.6rem;
            padding-bottom: 0.4rem; border-bottom: 1px solid var(--border-color);
        }
        .cost-line { display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; font-size: 0.78rem; }
        .cost-line .lbl { color: var(--text-secondary); }
        .cost-line .val { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--text-primary); }
        .cost-line.subtotal { border-top: 1px solid var(--border-color); margin-top: 0.4rem; padding-top: 0.4rem; }
        .cost-line.subtotal .lbl, .cost-line.subtotal .val { font-weight: 700; color: var(--accent-cyan); }
        .cost-totals { margin-top: 1.25rem; padding-top: 1rem; border-top: 2px solid var(--border-color); }
        .cost-total-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .cost-total-row .lbl { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .cost-total-row .val { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .cost-total-row.grand {
            background: var(--bg-tertiary); margin: 0.5rem -1rem; padding: 0.75rem 1rem; border-radius: 6px;
        }
        .cost-total-row.grand .lbl { color: var(--accent-green); font-size: 1rem; }
        .cost-total-row.grand .val { font-size: 1.4rem; color: var(--accent-green); }
        .markup-row { display: flex; align-items: center; gap: 1rem; padding: 0.5rem 0; }
        .markup-row label { font-size: 0.85rem; color: var(--text-secondary); }
        .markup-row input {
            width: 80px; padding: 0.4rem 0.5rem; border: 1px solid var(--border-color);
            border-radius: 4px; background: var(--bg-input); color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; text-align: right;
        }
        .markup-row input:focus { outline: none; border-color: var(--accent-green); }

        /* HeavyBid Summary */
        .hb-summary {
            background: var(--bg-secondary); border: 2px solid var(--accent-cyan);
            border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;
        }
        .hb-summary h2 {
            font-size: 1.1rem; font-weight: 700; color: var(--accent-cyan);
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);
        }
        .hb-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .hb-table th {
            text-align: left; padding: 0.5rem 0.6rem; font-size: 0.68rem;
            text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted);
            border-bottom: 2px solid var(--border-color); font-weight: 600;
        }
        .hb-table th:not(:first-child) { text-align: center; }
        .hb-table td { padding: 0.45rem 0.6rem; border-bottom: 1px solid var(--border-color); font-family: 'JetBrains Mono', monospace; }
        .hb-table td:first-child { font-family: 'IBM Plex Sans', sans-serif; font-weight: 600; color: var(--text-primary); }
        .hb-table td:not(:first-child) { text-align: center; }
        .hb-table .hb-cons { color: var(--accent-orange); }
        .hb-table .hb-std { color: var(--accent-cyan); font-weight: 700; }
        .hb-table .hb-agg { color: var(--accent-green); }

        /* Rate Config Panel */
        .rate-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        .rate-section {
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 1rem;
        }
        .rate-section h4 {
            font-size: 0.78rem; font-weight: 700; color: var(--accent-cyan);
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 0.6rem; padding-bottom: 0.4rem; border-bottom: 1px solid var(--border-color);
        }
        .rate-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
        .rate-row:last-child { margin-bottom: 0; }
        .rate-row label { font-size: 0.78rem; color: var(--text-secondary); }
        .rate-row input {
            width: 100px; padding: 0.35rem 0.5rem; border: 1px solid var(--border-color);
            border-radius: 4px; background: var(--bg-input); color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; text-align: right;
        }
        .rate-row input:focus { outline: none; border-color: var(--accent-cyan); }
        .rate-actions { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); justify-content: flex-end; }
        .tag { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; }
        .tag-red { background: var(--accent-red); }
        .tag-purple { background: var(--accent-purple); }
        .tag-yellow { background: var(--accent-yellow); }
        .tag-pink { background: var(--accent-pink); }
        .tag-blue { background: var(--accent-blue); }
        .tag-green { background: var(--accent-green); }
        .tag-teal { background: var(--accent-teal); }
        .tag-orange { background: var(--accent-orange); }
        .tag-cyan { background: var(--accent-cyan); }
        .toast {
            position: fixed; bottom: 2rem; right: 2rem; background: var(--accent-green);
            color: white; padding: 1rem 1.5rem; border-radius: 8px; font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); transform: translateY(100px);
            opacity: 0; transition: all 0.3s ease; z-index: 1000;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .footer {
            margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);
            text-align: center; font-size: 0.72rem; color: var(--text-muted);
        }
        .phase-input {
            width: 60px !important; display: inline-block;
        }
        .note { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; font-style: italic; }
        @media (max-width: 768px) {
            .wt-grid, .wt-grid-wide, .rate-grid, .cost-grid { grid-template-columns: 1fr; }
            .settings-row { flex-direction: column; gap: 0.75rem; }
            .header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
<div class="container">

<!-- Header -->
<header class="header">
    <div class="logo">
        <div class="logo-icon">M</div>
        <div class="logo-text">
            <h1>Maintenance Division Estimating Calculator</h1>
            <span>v3.0 | Field-Calibrated | Three-Tier Output | Striping Concurrency</span>
        </div>
    </div>
    <div class="header-controls">
        <button class="btn btn-primary" onclick="calculateAll()"><span>‚ö°</span> Calculate</button>
        <button class="btn btn-secondary" onclick="exportResults()"><span>üìã</span> Export</button>
        <button class="btn btn-danger" onclick="resetForm()"><span>‚Ü∫</span> Reset</button>
    </div>
</header>

<!-- Project Info -->
<div class="project-info">
    <label>Project</label>
    <input type="text" id="projectName" placeholder="Enter project name...">
</div>

<!-- Global Settings -->
<div class="settings-panel">
    <div class="settings-row">
        <div class="setting-group">
            <label>Hours / Day</label>
            <select id="hoursPerDay" onchange="calculateAll()">
                <option value="6">6 hours</option>
                <option value="8" selected>8 hours</option>
                <option value="10">10 hours</option>
            </select>
        </div>
        <div class="setting-group">
            <label>9.5mm Asphalt ($/ton)</label>
            <input type="number" id="asphaltPrice" placeholder="0.00" step="0.01" value="" oninput="calculateAll()">
        </div>
        <div class="setting-group">
            <label>19mm Base Asphalt ($/ton)</label>
            <input type="number" id="baseAsphaltPrice" placeholder="0.00" step="0.01" value="" oninput="calculateAll()">
        </div>
        <div class="setting-group">
            <label>DGA ($/ton)</label>
            <input type="number" id="dgaPrice" placeholder="0.00" step="0.01" value="" oninput="calculateAll()">
        </div>
        <div class="setting-group">
            <label>Markup %</label>
            <input type="number" id="markupPercent" value="15" step="1" oninput="calculateAll()">
        </div>
    </div>
</div>

<!-- Rate Configuration -->
<div class="panel-wrapper">
    <button class="panel-toggle" onclick="togglePanel(this,'rateContent')">
        <span>üí∞ Crew Rates, Material Costs & Production Rates (Click to Expand)</span>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="rateContent">
        <div class="rate-grid">
            <div class="rate-section">
                <h4>Crew Hourly Rates (Equip + Labor)</h4>
                <div class="rate-row"><label>Crack Fill Crew</label><input type="number" id="rateCrackFill" value="151.15" step="0.01"></div>
                <div class="rate-row"><label>Sealcoat Crew</label><input type="number" id="rateSealcoat" value="203.80" step="0.01"></div>
                <div class="rate-row"><label>Striping Crew</label><input type="number" id="rateStriping" value="136.55" step="0.01"></div>
                <div class="rate-row"><label>Asphalt Repair (‚â§4T)</label><input type="number" id="rateAsphaltSmall" value="297.28" step="0.01"></div>
                <div class="rate-row"><label>Asphalt Repair (>4T)</label><input type="number" id="rateAsphaltLarge" value="336.48" step="0.01"></div>
                <div class="rate-row"><label>Wheel Stop Install</label><input type="number" id="rateWsInstall" value="192.54" step="0.01"></div>
                <div class="rate-row"><label>Wheel Stop Reset</label><input type="number" id="rateWsReset" value="133.40" step="0.01"></div>
                <div class="rate-row"><label>Wheel Stop Removal</label><input type="number" id="rateWsRemove" value="179.94" step="0.01"></div>
                <div class="rate-row"><label>Rubber Speed Bump</label><input type="number" id="rateSpeedBump" value="199.90" step="0.01"></div>
                <div class="rate-row"><label>Bollard Crew</label><input type="number" id="rateBollard" value="293.23" step="0.01"></div>
                <div class="rate-row"><label>Sign Crew</label><input type="number" id="rateSign" value="293.23" step="0.01"></div>
                <div class="rate-row"><label>Mastic Crew (excl machine)</label><input type="number" id="rateMastic" value="173.45" step="0.01"></div>
                <div class="rate-row"><label>Inlet Crew</label><input type="number" id="rateInlet" value="213.55" step="0.01"></div>
                <div class="rate-row"><label>Speed Hump Crew</label><input type="number" id="rateSpeedHump" value="336.48" step="0.01"></div>
            </div>
            <div class="rate-section">
                <h4>Material Unit Costs</h4>
                <div class="rate-row"><label>Crack Fill ($/LF)</label><input type="number" id="matCrackFill" value="0.19" step="0.01"></div>
                <div class="rate-row"><label>Sealer ($/SF)</label><input type="number" id="matSealcoat" value="0.07" step="0.01"></div>
                <div class="rate-row"><label>4" Paint Lines ($/LF)</label><input type="number" id="mat4Line" value="0.10" step="0.01"></div>
                <div class="rate-row"><label>6" Paint Lines ($/LF)</label><input type="number" id="mat6Line" value="0.15" step="0.01"></div>
                <div class="rate-row"><label>12" Paint Lines ($/LF)</label><input type="number" id="mat12Line" value="0.30" step="0.01"></div>
                <div class="rate-row"><label>24" Paint Lines ($/LF)</label><input type="number" id="mat24Line" value="0.60" step="0.01"></div>
                <div class="rate-row"><label>Arrows ($/EA)</label><input type="number" id="matArrow" value="8.50" step="0.01"></div>
                <div class="rate-row"><label>HC Symbol w/ Hash ($/EA)</label><input type="number" id="matHC" value="12.50" step="0.01"></div>
                <div class="rate-row"><label>Stencils/Lettering ($/EA)</label><input type="number" id="matStencil" value="4.25" step="0.01"></div>
                <div class="rate-row"><label>Curb Paint ($/LF)</label><input type="number" id="matCurb" value="0.30" step="0.01"></div>
                <div class="rate-row"><label>Wheel Stop w/ Pins ($/UN)</label><input type="number" id="matWsNew" value="55.00" step="0.01"></div>
                <div class="rate-row"><label>WS Reset Pins ($/UN)</label><input type="number" id="matWsPin" value="4.00" step="0.01"></div>
                <div class="rate-row"><label>WS Disposal ($/UN)</label><input type="number" id="matWsDispose" value="16.67" step="0.01"></div>
                <div class="rate-row"><label>Rubber Speed Bump ($/UN)</label><input type="number" id="matSpeedBump" value="190.00" step="0.01"></div>
                <div class="rate-row"><label>Bollard ($/UN)</label><input type="number" id="matBollard" value="260.00" step="0.01"></div>
                <div class="rate-row"><label>Small Sign ($/UN)</label><input type="number" id="matSignSmall" value="30.00" step="0.01"></div>
                <div class="rate-row"><label>Large Sign ($/UN)</label><input type="number" id="matSignLarge" value="170.00" step="0.01"></div>
                <div class="rate-row"><label>Mastic ($/LF)</label><input type="number" id="matMastic" value="3.64" step="0.01"></div>
                <div class="rate-row"><label>Mastic Machine ($/DAY)</label><input type="number" id="matMasticMachine" value="584.40" step="0.01"></div>
                <div class="rate-row"><label>Block & Mortar ($/UN)</label><input type="number" id="matBlock" value="25.00" step="0.01"></div>
                <div class="rate-row"><label>Casting ($/EA)</label><input type="number" id="matCasting" value="300.00" step="0.01"></div>
                <div class="rate-row"><label>Grinder Rental ($/DAY)</label><input type="number" id="matPaintRemoval" value="650.00" step="0.01"></div>
            </div>
            <div class="rate-section">
                <h4>Production Rates (per day, standard crew)</h4>
                <div class="rate-row"><label>Crack Fill (LF/day)</label><input type="number" id="prodCrackFill" value="4000"></div>
                <div class="rate-row"><label>Sealcoat (SF/day)</label><input type="number" id="prodSealcoat" value="60000"></div>
                <div class="rate-row"><label>4" Lines (LF/day)</label><input type="number" id="prod4Line" value="5000"></div>
                <div class="rate-row"><label>6" Lines (LF/day)</label><input type="number" id="prod6Line" value="5000"></div>
                <div class="rate-row"><label>12" Lines (LF/day)</label><input type="number" id="prod12Line" value="5000"></div>
                <div class="rate-row"><label>24" Lines (LF/day)</label><input type="number" id="prod24Bar" value="3000"></div>
                <div class="rate-row"><label>HC Symbols (EA/day)</label><input type="number" id="prodHC" value="80"></div>
                <div class="rate-row"><label>Arrows (EA/day)</label><input type="number" id="prodArrow" value="50"></div>
                <div class="rate-row"><label>Stencils/Lettering (EA/day)</label><input type="number" id="prodStencil" value="200"></div>
                <div class="rate-row"><label>Curbing (LF/day)</label><input type="number" id="prodCurb" value="5000"></div>
                <div class="rate-row"><label>Asphalt Repair (SF/day)</label><input type="number" id="prodAsphaltRepair" value="600"></div>
                <div class="rate-row"><label>Wheel Stops (UN/day)</label><input type="number" id="prodWheelStop" value="80"></div>
                <div class="rate-row"><label>Rubber Speed Bumps (UN/day)</label><input type="number" id="prodSpeedBump" value="16"></div>
                <div class="rate-row"><label>Bollards (UN/day)</label><input type="number" id="prodBollard" value="8"></div>
                <div class="rate-row"><label>Signs - Post (UN/day)</label><input type="number" id="prodSignPost" value="32"></div>
                <div class="rate-row"><label>Signs - Bollard (UN/day)</label><input type="number" id="prodSignBollard" value="8"></div>
                <div class="rate-row"><label>Mastic (LF/day)</label><input type="number" id="prodMastic" value="1000"></div>
                <div class="rate-row"><label>Inlet Repair (UN/day)</label><input type="number" id="prodInletRepair" value="6"></div>
                <div class="rate-row"><label>Inlet Reconstruct (hrs/unit)</label><input type="number" id="prodInletRecon" value="8"></div>
                <div class="rate-row"><label>Speed Humps (UN/day)</label><input type="number" id="prodSpeedHump" value="4"></div>
                <div class="rate-row"><label>Paint Removal (LF/day)</label><input type="number" id="prodPaintRemoval" value="2000"></div>
            </div>
            <div class="rate-section">
                <h4>Default Crew Sizes</h4>
                <div class="rate-row"><label>Crack Fill</label><input type="number" id="crewCrackFill" value="3" min="2" max="5"></div>
                <div class="rate-row"><label>Sealcoat</label><input type="number" id="crewSealcoat" value="4" min="2" max="5"></div>
                <div class="rate-row"><label>Striping</label><input type="number" id="crewStriping" value="3" min="2" max="5"></div>
                <div class="rate-row"><label>Asphalt Repair (‚â§4T)</label><input type="number" id="crewAsphaltSmall" value="4" min="2" max="5"></div>
                <div class="rate-row"><label>Asphalt Repair (>4T)</label><input type="number" id="crewAsphaltLarge" value="4" min="2" max="5"></div>
                <div class="rate-row"><label>Wheel Stop Install</label><input type="number" id="crewWsInstall" value="3" min="2" max="5"></div>
                <div class="rate-row"><label>Rubber Speed Bump</label><input type="number" id="crewSpeedBump" value="3" min="2" max="5"></div>
                <div class="rate-row"><label>Bollard</label><input type="number" id="crewBollard" value="4" min="2" max="5"></div>
                <div class="rate-row"><label>Sign</label><input type="number" id="crewSign" value="3" min="2" max="5"></div>
                <div class="rate-row"><label>Mastic</label><input type="number" id="crewMastic" value="3" min="2" max="5"></div>
                <div class="rate-row"><label>Inlet</label><input type="number" id="crewInlet" value="4" min="2" max="5"></div>
                <div class="rate-row"><label>Speed Hump</label><input type="number" id="crewSpeedHump" value="4" min="2" max="5"></div>
            </div>
        </div>
        <div class="rate-actions">
            <button class="btn btn-success btn-small" onclick="saveRates()">üíæ Save Rates</button>
            <button class="btn btn-secondary btn-small" onclick="loadRates()">üìÇ Load Rates</button>
            <button class="btn btn-danger btn-small" onclick="clearSavedRates()">üóëÔ∏è Clear Saved</button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- WORK TYPE SECTIONS -->
<!-- ============================================ -->

<!-- 1. CRACK FILLING -->
<div class="panel-wrapper" id="wt_crackfill_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_crackfill')">
        <div class="toggle-left">
            <input type="checkbox" id="en_crackfill" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-orange"></span>Crack Filling</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_crackfill">
        <div class="wt-grid">
            <div class="input-group"><label>Linear Feet (LF)</label><input type="number" id="cf_lf" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="cf_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <div class="output-section"><h5>Crack Filling Output</h5><div id="cf_output"></div></div>
    </div>
</div>

<!-- 2. SEALCOATING -->
<div class="panel-wrapper" id="wt_sealcoat_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_sealcoat')">
        <div class="toggle-left">
            <input type="checkbox" id="en_sealcoat" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-blue"></span>Seal Coating</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_sealcoat">
        <div class="wt-grid">
            <div class="input-group"><label>Square Feet (SF)</label><input type="number" id="sc_sf" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="sc_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <div class="output-section"><h5>Sealcoating Output</h5><div id="sc_output"></div></div>
    </div>
</div>

<!-- 3. STRIPING -->
<div class="panel-wrapper" id="wt_striping_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_striping')">
        <div class="toggle-left">
            <input type="checkbox" id="en_striping" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-yellow"></span>Striping</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_striping">
        <div class="wt-grid" style="margin-bottom:0.5rem;">
            <div class="input-group"><label>Phases</label><input type="number" id="st_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <p style="font-size:0.65rem; color:var(--text-muted); margin-bottom:0.5rem;">
            <span style="display:inline-block;width:10px;height:10px;background:var(--accent-blue);border-radius:2px;vertical-align:middle;margin-right:3px;"></span> Machine items
            <span style="display:inline-block;width:10px;height:10px;background:var(--accent-yellow);border-radius:2px;vertical-align:middle;margin-left:10px;margin-right:3px;"></span> Hand items (concurrent with machine)
        </p>
        <table class="stripe-table">
            <thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Prod/Day</th><th>Hours</th><th>Mat Cost</th></tr></thead>
            <tbody>
                <tr class="machine-row"><td>4" Lines</td><td><input type="number" id="st_4line" placeholder="0" oninput="calculateAll()"></td><td class="unit">LF</td><td class="calc-val" id="st_4line_prod">5,000</td><td class="calc-val" id="st_4line_hrs">0</td><td class="calc-val" id="st_4line_mat">$0</td></tr>
                <tr class="machine-row"><td>6" Lines</td><td><input type="number" id="st_6line" placeholder="0" oninput="calculateAll()"></td><td class="unit">LF</td><td class="calc-val" id="st_6line_prod">5,000</td><td class="calc-val" id="st_6line_hrs">0</td><td class="calc-val" id="st_6line_mat">$0</td></tr>
                <tr class="machine-row"><td>12" Lines</td><td><input type="number" id="st_12line" placeholder="0" oninput="calculateAll()"></td><td class="unit">LF</td><td class="calc-val" id="st_12line_prod">5,000</td><td class="calc-val" id="st_12line_hrs">0</td><td class="calc-val" id="st_12line_mat">$0</td></tr>
                <tr class="machine-row"><td>24" Lines</td><td><input type="number" id="st_24bar" placeholder="0" oninput="calculateAll()"></td><td class="unit">LF</td><td class="calc-val" id="st_24bar_prod">3,000</td><td class="calc-val" id="st_24bar_hrs">0</td><td class="calc-val" id="st_24bar_mat">$0</td></tr>
                <tr class="hand-row"><td>HC Symbols</td><td><input type="number" id="st_hc" placeholder="0" oninput="calculateAll()"></td><td class="unit">EA</td><td class="calc-val" id="st_hc_prod">80</td><td class="calc-val" id="st_hc_hrs">0</td><td class="calc-val" id="st_hc_mat">$0</td></tr>
                <tr class="hand-row"><td>Arrows</td><td><input type="number" id="st_arrow" placeholder="0" oninput="calculateAll()"></td><td class="unit">EA</td><td class="calc-val" id="st_arrow_prod">50</td><td class="calc-val" id="st_arrow_hrs">0</td><td class="calc-val" id="st_arrow_mat">$0</td></tr>
                <tr class="hand-row"><td>Stencils / Lettering</td><td><input type="number" id="st_stencil" placeholder="0" oninput="calculateAll()"></td><td class="unit">EA</td><td class="calc-val" id="st_stencil_prod">200</td><td class="calc-val" id="st_stencil_hrs">0</td><td class="calc-val" id="st_stencil_mat">$0</td></tr>
                <tr class="hand-row"><td>Curbing</td><td><input type="number" id="st_curb" placeholder="0" oninput="calculateAll()"></td><td class="unit">LF</td><td class="calc-val" id="st_curb_prod">5,000</td><td class="calc-val" id="st_curb_hrs">0</td><td class="calc-val" id="st_curb_mat">$0</td></tr>
            </tbody>
        </table>
        <p class="note">HC symbol count is for symbol painting only. Line footage for HC stalls is included in 4" line quantities.</p>
        <div class="output-section">
            <h5>Striping Output (Concurrency: max of machine / hand hours)</h5>
            <div class="output-row"><span class="lbl">Machine Hours (lines)</span><span class="val" id="st_machineHrs">0</span></div>
            <div class="output-row"><span class="lbl">Hand Hours (symbols/stencils/curb)</span><span class="val" id="st_handHrs">0</span></div>
            <div class="output-divider"></div>
            <div id="st_output"></div>
        </div>
    </div>
</div>

<!-- 4. ASPHALT REPAIRS -->
<div class="panel-wrapper" id="wt_asphalt_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_asphalt')">
        <div class="toggle-left">
            <input type="checkbox" id="en_asphalt" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-red"></span>Asphalt Repairs</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_asphalt">
        <div class="wt-grid">
            <div class="input-group"><label>Total Repair Area (SF)</label><input type="number" id="ar_sf" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Depth Configuration</label>
                <select id="ar_depth" onchange="calculateAll()">
                    <option value="2s">2" Surface Only (9.5mm)</option>
                    <option value="2s4b">2" Surface + 4" Base (19mm)</option>
                    <option value="2s4d">2" Surface + 4" DGA</option>
                    <option value="2s4b4d">2" Surface + 4" Base + 4" DGA</option>
                    <option value="2s4b6d">2" Surface + 4" Base + 6" DGA</option>
                    <option value="2s6d">2" Surface + 6" DGA</option>
                </select>
            </div>
            <div class="input-group"><label>Phases</label><input type="number" id="ar_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <div class="output-section">
            <h5>Asphalt Repair Output</h5>
            <div class="output-row"><span class="lbl">9.5mm Surface (tons)</span><span class="val" id="ar_surfTons">0</span></div>
            <div class="output-row"><span class="lbl">19mm Base (tons)</span><span class="val" id="ar_baseTons">0</span></div>
            <div class="output-row"><span class="lbl">DGA (tons)</span><span class="val" id="ar_dgaTons">0</span></div>
            <div class="output-row highlight"><span class="lbl">Total Asphalt (tons)</span><span class="val" id="ar_totalTons">0</span></div>
            <div class="output-row"><span class="lbl">Crew Type</span><span class="val" id="ar_crewType">-</span></div>
            <div class="output-divider"></div>
            <div id="ar_output"></div>
        </div>
    </div>
</div>

<!-- 5. MASTIC CRACK FILLING -->
<div class="panel-wrapper" id="wt_mastic_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_mastic')">
        <div class="toggle-left">
            <input type="checkbox" id="en_mastic" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-purple"></span>Mastic Crack Filling</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_mastic">
        <div class="wt-grid">
            <div class="input-group"><label>Linear Feet (LF)</label><input type="number" id="ma_lf" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="ma_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <p class="note">Includes 1 full day labor for machine pickup/dropoff. Machine rental charged per production day.</p>
        <div class="output-section"><h5>Mastic Output</h5><div id="ma_output"></div></div>
    </div>
</div>

<!-- 6. WHEEL STOPS -->
<div class="panel-wrapper" id="wt_wheelstop_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_wheelstop')">
        <div class="toggle-left">
            <input type="checkbox" id="en_wheelstop" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-teal"></span>Wheel Stops</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_wheelstop">
        <div class="wt-grid">
            <div class="input-group"><label>New Installs (qty)</label><input type="number" id="ws_new" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Reset / Re-pin (qty)</label><input type="number" id="ws_reset" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Remove & Dispose (qty)</label><input type="number" id="ws_remove" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="ws_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <div class="output-section"><h5>Wheel Stop Output</h5><div id="ws_output"></div></div>
    </div>
</div>

<!-- 7. SIGNS -->
<div class="panel-wrapper" id="wt_sign_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_sign')">
        <div class="toggle-left">
            <input type="checkbox" id="en_sign" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-green"></span>Signs</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_sign">
        <div class="wt-grid">
            <div class="input-group"><label>Signs on Post (qty)</label><input type="number" id="sg_post" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Signs in Bollard (qty)</label><input type="number" id="sg_bollard" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="sg_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <p class="note">Post signs include small and large at blended rate of 32/day. Bollard signs include sign + bollard material costs.</p>
        <div class="output-section"><h5>Sign Output</h5><div id="sg_output"></div></div>
    </div>
</div>

<!-- 8. BOLLARD REPLACEMENT -->
<div class="panel-wrapper" id="wt_bollard_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_bollard')">
        <div class="toggle-left">
            <input type="checkbox" id="en_bollard" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-pink"></span>Bollard Replacement</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_bollard">
        <div class="wt-grid">
            <div class="input-group"><label>Bollards (qty)</label><input type="number" id="bo_qty" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="bo_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <div class="output-section"><h5>Bollard Output</h5><div id="bo_output"></div></div>
    </div>
</div>

<!-- 9. RUBBER SPEED BUMPS -->
<div class="panel-wrapper" id="wt_speedbump_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_speedbump')">
        <div class="toggle-left">
            <input type="checkbox" id="en_speedbump" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-cyan"></span>Rubber Speed Bumps</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_speedbump">
        <div class="wt-grid">
            <div class="input-group"><label>Speed Bumps (qty)</label><input type="number" id="sb_qty" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="sb_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <div class="output-section"><h5>Rubber Speed Bump Output</h5><div id="sb_output"></div></div>
    </div>
</div>

<!-- 10. SPEED HUMPS -->
<div class="panel-wrapper" id="wt_speedhump_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_speedhump')">
        <div class="toggle-left">
            <input type="checkbox" id="en_speedhump" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-orange"></span>Asphalt Speed Humps</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_speedhump">
        <div class="wt-grid">
            <div class="input-group"><label>Speed Humps (qty)</label><input type="number" id="sh_qty" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Installation Context</label>
                <select id="sh_type" onchange="calculateAll()">
                    <option value="existing">Existing Asphalt</option>
                    <option value="millpave">During Mill & Pave</option>
                </select>
            </div>
            <div class="input-group"><label>Phases</label><input type="number" id="sh_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <p class="note">2.13 tons of 9.5mm asphalt per hump (sinusoidal profile, 16'x13'x2.64").</p>
        <div class="output-section"><h5>Speed Hump Output</h5>
            <div class="output-row"><span class="lbl">Asphalt (tons)</span><span class="val" id="sh_tons">0</span></div>
            <div class="output-divider"></div>
            <div id="sh_output"></div>
        </div>
    </div>
</div>

<!-- 11. INLET REPAIR -->
<div class="panel-wrapper" id="wt_inlet_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_inlet')">
        <div class="toggle-left">
            <input type="checkbox" id="en_inlet" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-teal"></span>Inlet Repair / Reconstruction</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_inlet">
        <div class="wt-grid">
            <div class="input-group"><label>Repairs (parge & asphalt, qty)</label><input type="number" id="in_repair" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Reconstructions (qty)</label><input type="number" id="in_recon" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Castings Required (qty)</label><input type="number" id="in_casting" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="in_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <p class="note">Repair = 6 units/day (4-man crew). Reconstruction hours depend on scope.</p>
        <div class="output-section"><h5>Inlet Output</h5><div id="in_output"></div></div>
    </div>
</div>

<!-- 12. PAINT STRIPING REMOVAL -->
<div class="panel-wrapper" id="wt_paintremoval_wrapper">
    <button class="panel-toggle" onclick="toggleWorkType(this,'wt_paintremoval')">
        <div class="toggle-left">
            <input type="checkbox" id="en_paintremoval" onclick="event.stopPropagation(); calculateAll();" checked>
            <span><span class="tag tag-pink"></span>Paint Striping Removal</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="wt_paintremoval">
        <div class="wt-grid">
            <div class="input-group"><label>Linear Feet (LF)</label><input type="number" id="pr_lf" placeholder="0" oninput="calculateAll()"></div>
            <div class="input-group"><label>Phases</label><input type="number" id="pr_phases" class="phase-input" value="1" min="1" oninput="calculateAll()"></div>
        </div>
        <p class="note">Uses striping crew + grinder rental per day. Grinder runs concurrent with hand painting when both are on the same job.</p>
        <div class="output-section"><h5>Paint Removal Output</h5><div id="pr_output"></div></div>
    </div>
</div>

<!-- ============================================ -->
<!-- ESTIMATE SUMMARY -->
<!-- ============================================ -->
<div class="hb-summary">
    <h2>üìä Estimate Summary (Three-Tier Comparison)</h2>
    <p style="font-size:0.72rem; color:var(--text-muted); margin-bottom:1rem;">
        Crew sizes and hours per activity. Standard = Darrell's standalone rates. Conservative = 80% production. Aggressive = 120% production. Same crew for all tiers.
    </p>
    <div style="overflow-x:auto;">
        <table class="hb-table" id="hbTable">
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>Crew</th>
                    <th colspan="2" style="text-align:center; color:var(--accent-orange);">Conservative</th>
                    <th colspan="2" style="text-align:center; color:var(--accent-cyan);">Standard</th>
                    <th colspan="2" style="text-align:center; color:var(--accent-green);">Aggressive</th>
                </tr>
                <tr>
                    <th></th>
                    <th></th>
                    <th>Hours</th><th>Days</th>
                    <th>Hours</th><th>Days</th>
                    <th>Hours</th><th>Days</th>
                </tr>
            </thead>
            <tbody id="hbBody">
                <tr><td colspan="8" style="text-align:center; color:var(--text-muted); padding:1rem;">Enter quantities above to see estimate data</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ============================================ -->
<!-- COMBINED COST SUMMARY -->
<!-- ============================================ -->
<div class="cost-summary">
    <h2>üíµ Combined Cost Summary (Standard Tier)</h2>
    <div class="cost-grid">
        <div class="cost-category">
            <h4>Labor & Equipment by Work Type</h4>
            <div class="cost-line" id="sum_cf_row"><span class="lbl">Crack Filling</span><span class="val" id="sum_cf">$0</span></div>
            <div class="cost-line" id="sum_sc_row"><span class="lbl">Seal Coating</span><span class="val" id="sum_sc">$0</span></div>
            <div class="cost-line" id="sum_st_row"><span class="lbl">Striping</span><span class="val" id="sum_st">$0</span></div>
            <div class="cost-line" id="sum_ar_row"><span class="lbl">Asphalt Repairs</span><span class="val" id="sum_ar">$0</span></div>
            <div class="cost-line" id="sum_ma_row"><span class="lbl">Mastic Crack Fill</span><span class="val" id="sum_ma">$0</span></div>
            <div class="cost-line" id="sum_ws_row"><span class="lbl">Wheel Stops</span><span class="val" id="sum_ws">$0</span></div>
            <div class="cost-line" id="sum_sg_row"><span class="lbl">Signs</span><span class="val" id="sum_sg">$0</span></div>
            <div class="cost-line" id="sum_bo_row"><span class="lbl">Bollards</span><span class="val" id="sum_bo">$0</span></div>
            <div class="cost-line" id="sum_sb_row"><span class="lbl">Rubber Speed Bumps</span><span class="val" id="sum_sb">$0</span></div>
            <div class="cost-line" id="sum_sh_row"><span class="lbl">Speed Humps</span><span class="val" id="sum_sh">$0</span></div>
            <div class="cost-line" id="sum_in_row"><span class="lbl">Inlet Repair</span><span class="val" id="sum_in">$0</span></div>
            <div class="cost-line" id="sum_pr_row"><span class="lbl">Paint Removal</span><span class="val" id="sum_pr">$0</span></div>
            <div class="cost-line subtotal"><span class="lbl">Labor & Equip Subtotal</span><span class="val" id="sum_laborTotal">$0</span></div>
        </div>
        <div class="cost-category">
            <h4>Materials by Work Type</h4>
            <div class="cost-line" id="summ_cf_row"><span class="lbl">Crack Fill Material</span><span class="val" id="summ_cf">$0</span></div>
            <div class="cost-line" id="summ_sc_row"><span class="lbl">Sealer</span><span class="val" id="summ_sc">$0</span></div>
            <div class="cost-line" id="summ_st_row"><span class="lbl">Striping Paint</span><span class="val" id="summ_st">$0</span></div>
            <div class="cost-line" id="summ_ar_row"><span class="lbl">Asphalt / DGA</span><span class="val" id="summ_ar">$0</span></div>
            <div class="cost-line" id="summ_ma_row"><span class="lbl">Mastic + Machine</span><span class="val" id="summ_ma">$0</span></div>
            <div class="cost-line" id="summ_ws_row"><span class="lbl">Wheel Stops</span><span class="val" id="summ_ws">$0</span></div>
            <div class="cost-line" id="summ_sg_row"><span class="lbl">Signs</span><span class="val" id="summ_sg">$0</span></div>
            <div class="cost-line" id="summ_bo_row"><span class="lbl">Bollards</span><span class="val" id="summ_bo">$0</span></div>
            <div class="cost-line" id="summ_sb_row"><span class="lbl">Speed Bumps</span><span class="val" id="summ_sb">$0</span></div>
            <div class="cost-line" id="summ_sh_row"><span class="lbl">Speed Humps</span><span class="val" id="summ_sh">$0</span></div>
            <div class="cost-line" id="summ_in_row"><span class="lbl">Inlet (Block/Casting)</span><span class="val" id="summ_in">$0</span></div>
            <div class="cost-line" id="summ_pr_row"><span class="lbl">Grinder Rental</span><span class="val" id="summ_pr">$0</span></div>
            <div class="cost-line subtotal"><span class="lbl">Materials Subtotal</span><span class="val" id="sum_matTotal">$0</span></div>
        </div>
    </div>
    <div class="cost-totals">
        <div class="cost-total-row">
            <span class="lbl">Direct Cost Total</span>
            <span class="val" id="directCostTotal">$0</span>
        </div>
        <div class="markup-row">
            <label>Markup %</label>
            <input type="number" id="markupPercent2" value="15" step="1" oninput="syncMarkup(this); calculateAll();">
            <span style="color:var(--text-muted)">%</span>
            <span class="val" style="margin-left:auto;" id="markupAmount">$0</span>
        </div>
        <div class="cost-total-row grand">
            <span class="lbl">BID PRICE</span>
            <span class="val" id="bidPrice">$0</span>
        </div>
    </div>
</div>

<!-- HISTORICAL BENCHMARKING REFERENCE -->
<div class="panel-wrapper">
    <button class="panel-toggle" onclick="togglePanel(this, 'benchContent')">
        <div class="toggle-left">
            <span><span class="tag" style="background:var(--accent-cyan);"></span>Historical Benchmarking Reference</span>
        </div>
        <span class="arrow">‚ñº</span>
    </button>
    <div class="panel-content" id="benchContent">
        <p style="font-size:0.72rem; color:var(--text-muted); margin-bottom:0.75rem; font-style:italic;">
            All-in unit costs (labor + equipment + material) from 347 historical jobs (Dec 2024 - Dec 2025).
            Costs are heavily influenced by job size. Small quantities carry proportionally higher crew mobilization costs.
        </p>
        <div style="overflow-x:auto;">
        <table class="stripe-table" style="font-size:0.72rem;">
            <thead>
                <tr>
                    <th style="text-align:left;">Item</th>
                    <th>Unit</th>
                    <th>Median $/Unit</th>
                    <th>P25 - P75</th>
                    <th>Typical Qty Range</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Crack Fill</td><td>LF</td><td>$1.05</td><td>$0.60 - $2.20</td><td>500 - 10,000</td></tr>
                <tr><td>Sealcoat</td><td>SF</td><td>$0.10</td><td>$0.07 - $0.14</td><td>15,000 - 300,000</td></tr>
                <tr><td>4" Lines</td><td>LF</td><td>$0.32</td><td>$0.20 - $0.55</td><td>1,000 - 25,000</td></tr>
                <tr><td>Arrows</td><td>EA</td><td>$30.00</td><td>$18.00 - $50.00</td><td>10 - 100</td></tr>
                <tr><td>HC Symbols</td><td>EA</td><td>$45.00</td><td>$25.00 - $75.00</td><td>2 - 20</td></tr>
                <tr><td>Asphalt Repair</td><td>SF</td><td>$22.00</td><td>$14.00 - $35.00</td><td>50 - 2,000</td></tr>
                <tr><td>Wheel Stops (new)</td><td>UN</td><td>$95.00</td><td>$75.00 - $130.00</td><td>5 - 100</td></tr>
                <tr><td>Bollards</td><td>UN</td><td>$550.00</td><td>$400.00 - $750.00</td><td>2 - 20</td></tr>
                <tr><td>Speed Bumps (rubber)</td><td>UN</td><td>$350.00</td><td>$280.00 - $500.00</td><td>2 - 10</td></tr>
                <tr><td>Inlet Repair</td><td>UN</td><td>$967.00</td><td>$750.00 - $1,200.00</td><td>1 - 8</td></tr>
                <tr><td>Inlet Reconstruction</td><td>UN</td><td>$1,053.00</td><td>$800.00 - $1,500.00</td><td>1 - 4</td></tr>
            </tbody>
        </table>
        </div>
    </div>
</div>

<div class="footer">
    Maintenance Division Estimating Calculator v3.0 | Field-Calibrated Production Rates | Three-Tier Output | Striping Concurrency Model<br>
    All rates subject to superintendent review.
</div>

<div class="toast" id="toast"></div>

<script>
// ===== UTILITY FUNCTIONS =====
function gv(id) { return parseFloat(document.getElementById(id)?.value) || 0; }
function sv(id, val) { const el = document.getElementById(id); if (el) el.textContent = val; }
function fmt(n) { return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function fmt2(n) { return n > 0 ? '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '$0'; }
function isOn(id) { return document.getElementById(id)?.checked; }

function togglePanel(btn, contentId) {
    btn.classList.toggle('open');
    document.getElementById(contentId).classList.toggle('open');
}
function toggleWorkType(btn, contentId) {
    btn.classList.toggle('open');
    document.getElementById(contentId).classList.toggle('open');
}
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}
function syncMarkup(el) {
    const other = el.id === 'markupPercent' ? 'markupPercent2' : 'markupPercent';
    document.getElementById(other).value = el.value;
}

// ===== CORE PHASING LOGIC =====
// Production days from quantity/rate, then apply phase minimum
function calcPhasedHours(qty, prodPerDay, hpd, phases, minHrs) {
    if (qty <= 0) return { hours: 0, days: 0, productionDays: 0 };
    const productionDays = qty / prodPerDay;
    const actualDays = Math.max(productionDays, phases);
    const hours = Math.max(actualDays * hpd, minHrs);
    const days = hours / hpd;
    return { hours, days, productionDays };
}

// ===== THREE-TIER CALCULATOR =====
// Returns { cons, std, agg } each with { crew, hours, days }
// All tiers use standard crew. Tiers differ only in production rate assumptions.
function calcThreeTier(qty, prodPerDay, hpd, phases, minHrs, stdCrew) {
    if (qty <= 0) return null;

    // Standard: full crew at Darrell's standalone rate
    const std = calcPhasedHours(qty, prodPerDay, hpd, phases, minHrs);

    // Conservative: 80% production rate (more hours)
    const consProd = prodPerDay * 0.80;
    const cons = calcPhasedHours(qty, consProd, hpd, phases, minHrs);

    // Aggressive: 120% production rate (fewer hours)
    const aggProd = prodPerDay * 1.20;
    const agg = calcPhasedHours(qty, aggProd, hpd, phases, minHrs);

    return {
        cons: { crew: stdCrew, hours: cons.hours, days: Math.ceil(cons.days) },
        std:  { crew: stdCrew, hours: std.hours, days: Math.ceil(std.days) },
        agg:  { crew: stdCrew, hours: agg.hours, days: Math.ceil(agg.days) }
    };
}

// ===== RENDER STANDARD OUTPUT INTO WORK TYPE PANEL =====
function renderTierTable(containerId, tierData, rate, matCost, extra) {
    const el = document.getElementById(containerId);
    if (!el) return;
    if (!tierData) {
        el.innerHTML = '<div class="output-row"><span class="lbl">No quantity entered</span><span class="val">-</span></div>';
        return;
    }

    const { std } = tierData;
    const extraCost = extra || 0;
    const laborCost = std.hours * rate;

    let html = '';
    html += `<div class="output-row"><span class="lbl">Crew Size</span><span class="val">${std.crew}</span></div>`;
    html += `<div class="output-row"><span class="lbl">Hours</span><span class="val">${std.hours.toFixed(1)}</span></div>`;
    html += `<div class="output-row"><span class="lbl">Days</span><span class="val">${std.days}</span></div>`;
    html += `<div class="output-divider"></div>`;
    html += `<div class="output-row cost"><span class="lbl">Labor & Equip</span><span class="val">${fmt(laborCost)}</span></div>`;
    html += `<div class="output-row cost"><span class="lbl">Material</span><span class="val">${fmt(matCost)}</span></div>`;
    if (extra) {
        html += `<div class="output-row cost"><span class="lbl">Equipment/Rental</span><span class="val">${fmt(extra)}</span></div>`;
    }
    html += `<div class="output-row highlight"><span class="lbl">Total</span><span class="val">${fmt(laborCost + matCost + extraCost)}</span></div>`;

    el.innerHTML = html;
}

// ===== MAIN CALCULATION =====
function calculateAll() {
    const hpd = gv('hoursPerDay');
    const minHrs = 4;
    const asphaltPrice = gv('asphaltPrice');
    const baseAsphaltPrice = gv('baseAsphaltPrice');
    const dgaPrice = gv('dgaPrice');

    let sumLabor = {}, sumMat = {};
    const workTypes = ['cf','sc','st','ar','ma','ws','sg','bo','sb','sh','in','pr'];
    workTypes.forEach(k => { sumLabor[k] = 0; sumMat[k] = 0; });

    // Collect HeavyBid rows
    let hbRows = [];

    // === CRACK FILLING ===
    if (isOn('en_crackfill')) {
        const lf = gv('cf_lf');
        const rate = gv('rateCrackFill');
        const prod = gv('prodCrackFill');
        const phases = Math.max(gv('cf_phases'), 1);
        const crew = gv('crewCrackFill');
        const matCost = lf * gv('matCrackFill');
        const tier = calcThreeTier(lf, prod, hpd, phases, minHrs, crew);
        renderTierTable('cf_output', tier, rate, matCost);
        if (tier) {
            sumLabor.cf = tier.std.hours * rate;
            sumMat.cf = matCost;
            hbRows.push({ name: 'Crack Filling', tier });
        }
    } else { renderTierTable('cf_output', null); }

    // === SEALCOATING ===
    if (isOn('en_sealcoat')) {
        const sf = gv('sc_sf');
        const rate = gv('rateSealcoat');
        const prod = gv('prodSealcoat');
        const phases = Math.max(gv('sc_phases'), 1);
        const crew = gv('crewSealcoat');
        const matCost = sf * gv('matSealcoat');
        const tier = calcThreeTier(sf, prod, hpd, phases, minHrs, crew);
        renderTierTable('sc_output', tier, rate, matCost);
        if (tier) {
            sumLabor.sc = tier.std.hours * rate;
            sumMat.sc = matCost;
            hbRows.push({ name: 'Sealcoating', tier });
        }
    } else { renderTierTable('sc_output', null); }

    // === STRIPING (with concurrency) ===
    if (isOn('en_striping')) {
        const rate = gv('rateStriping');
        const phases = Math.max(gv('st_phases'), 1);
        const crew = gv('crewStriping');

        // Machine items: 4", 6", 12", 24" lines + paint removal (if active, handled below)
        const machineItems = [
            { qtyId:'st_4line', prodId:'prod4Line', matId:'mat4Line', hrsId:'st_4line_hrs', matOutId:'st_4line_mat', prodOutId:'st_4line_prod' },
            { qtyId:'st_6line', prodId:'prod6Line', matId:'mat6Line', hrsId:'st_6line_hrs', matOutId:'st_6line_mat', prodOutId:'st_6line_prod' },
            { qtyId:'st_12line', prodId:'prod12Line', matId:'mat12Line', hrsId:'st_12line_hrs', matOutId:'st_12line_mat', prodOutId:'st_12line_prod' },
            { qtyId:'st_24bar', prodId:'prod24Bar', matId:'mat24Line', hrsId:'st_24bar_hrs', matOutId:'st_24bar_mat', prodOutId:'st_24bar_prod' },
        ];
        // Hand items: HC symbols, arrows, stencils, curbing
        const handItems = [
            { qtyId:'st_hc', prodId:'prodHC', matId:'matHC', hrsId:'st_hc_hrs', matOutId:'st_hc_mat', prodOutId:'st_hc_prod' },
            { qtyId:'st_arrow', prodId:'prodArrow', matId:'matArrow', hrsId:'st_arrow_hrs', matOutId:'st_arrow_mat', prodOutId:'st_arrow_prod' },
            { qtyId:'st_stencil', prodId:'prodStencil', matId:'matStencil', hrsId:'st_stencil_hrs', matOutId:'st_stencil_mat', prodOutId:'st_stencil_prod' },
            { qtyId:'st_curb', prodId:'prodCurb', matId:'matCurb', hrsId:'st_curb_hrs', matOutId:'st_curb_mat', prodOutId:'st_curb_prod' },
        ];

        let machineHrs = 0, handHrs = 0, totalMat = 0;

        function calcStripingGroup(items) {
            let groupHrs = 0;
            items.forEach(item => {
                const qty = gv(item.qtyId);
                const prod = gv(item.prodId);
                const matUnit = gv(item.matId);
                const itemHrs = qty > 0 && prod > 0 ? (qty / prod) * hpd : 0;
                const itemMat = qty * matUnit;
                groupHrs += itemHrs;
                totalMat += itemMat;
                sv(item.hrsId, itemHrs.toFixed(1));
                sv(item.matOutId, fmt2(itemMat));
                sv(item.prodOutId, prod.toLocaleString());
            });
            return groupHrs;
        }

        machineHrs = calcStripingGroup(machineItems);
        handHrs = calcStripingGroup(handItems);

        // Concurrency: total = max(machine, hand), not sum
        const concurrentHrs = Math.max(machineHrs, handHrs);

        sv('st_machineHrs', machineHrs.toFixed(1));
        sv('st_handHrs', handHrs.toFixed(1));

        // Apply phasing to the concurrent total
        const hasQty = concurrentHrs > 0;
        if (hasQty) {
            // Convert concurrent hours back to equivalent "production days"
            const equivProdDays = concurrentHrs / hpd;
            const actualDays = Math.max(equivProdDays, phases);
            const stdHrs = Math.max(actualDays * hpd, minHrs);
            const stdDays = stdHrs / hpd;

            // Conservative: 80% rate means more hours
            const consEquivDays = (concurrentHrs / 0.80) / hpd;
            const consActualDays = Math.max(consEquivDays, phases);
            const consHrs = Math.max(consActualDays * hpd, minHrs);

            // Aggressive: 120% rate means fewer hours
            const aggEquivDays = (concurrentHrs / 1.20) / hpd;
            const aggActualDays = Math.max(aggEquivDays, phases);
            const aggHrs = Math.max(aggActualDays * hpd, minHrs);

            const tier = {
                cons: { crew: crew, hours: consHrs, days: Math.ceil(consActualDays) },
                std:  { crew: crew, hours: stdHrs, days: Math.ceil(stdHrs / hpd) },
                agg:  { crew: crew, hours: aggHrs, days: Math.ceil(aggActualDays) }
            };

            renderTierTable('st_output', tier, rate, totalMat);
            sumLabor.st = stdHrs * rate;
            sumMat.st = totalMat;
            hbRows.push({ name: 'Striping', tier, note: `Machine: ${machineHrs.toFixed(1)}h / Hand: ${handHrs.toFixed(1)}h / Concurrent: ${concurrentHrs.toFixed(1)}h` });
        } else {
            renderTierTable('st_output', null);
        }
    } else {
        ['st_machineHrs','st_handHrs'].forEach(id => sv(id, '0'));
        renderTierTable('st_output', null);
    }

    // === ASPHALT REPAIRS ===
    if (isOn('en_asphalt')) {
        const sf = gv('ar_sf');
        const depthConfig = document.getElementById('ar_depth').value;
        const prod = gv('prodAsphaltRepair');
        const phases = Math.max(gv('ar_phases'), 1);

        const sy = sf / 9;
        let surfTons = 0, baseTons = 0, dgaTons = 0;
        if (sf > 0) {
            if (depthConfig.includes('2s')) surfTons = Math.ceil(sy * 2 * 0.0575);
            if (depthConfig.includes('4b')) baseTons = Math.ceil(sy * 4 * 0.0575);
            if (depthConfig.includes('4d')) dgaTons = Math.ceil((sf * 4 / 324) * 1.9);
            if (depthConfig.includes('6d')) dgaTons = Math.ceil((sf * 6 / 324) * 1.9);
        }

        const totalAsphaltTons = surfTons + baseTons;
        const crewIsLarge = totalAsphaltTons > 4;
        const crewRate = crewIsLarge ? gv('rateAsphaltLarge') : gv('rateAsphaltSmall');
        const crew = crewIsLarge ? gv('crewAsphaltLarge') : gv('crewAsphaltSmall');
        const matAsphalt = (surfTons * asphaltPrice) + (baseTons * baseAsphaltPrice);
        const matDGA = dgaTons * dgaPrice;
        const totalMat = matAsphalt + matDGA;

        sv('ar_surfTons', surfTons);
        sv('ar_baseTons', baseTons);
        sv('ar_dgaTons', dgaTons);
        sv('ar_totalTons', totalAsphaltTons);
        sv('ar_crewType', crewIsLarge ? '> 4T (Triaxle)' : '‚â§ 4T (Hot Box)');

        const tier = calcThreeTier(sf, prod, hpd, phases, minHrs, crew);
        renderTierTable('ar_output', tier, crewRate, totalMat);
        if (tier) {
            sumLabor.ar = tier.std.hours * crewRate;
            sumMat.ar = totalMat;
            hbRows.push({ name: 'Asphalt Repair', tier });
        }
    } else {
        ['ar_surfTons','ar_baseTons','ar_dgaTons','ar_totalTons'].forEach(id => sv(id, '0'));
        sv('ar_crewType', '-');
        renderTierTable('ar_output', null);
    }

    // === MASTIC ===
    if (isOn('en_mastic')) {
        const lf = gv('ma_lf');
        const crewRate = gv('rateMastic');
        const prod = gv('prodMastic');
        const phases = Math.max(gv('ma_phases'), 1);
        const crew = gv('crewMastic');
        const matPerLF = gv('matMastic');
        const machinePerDay = gv('matMasticMachine');

        if (lf > 0) {
            const tier = calcThreeTier(lf, prod, hpd, phases, minHrs, crew);
            // Add 1 day for pickup/dropoff to all tiers
            const pudoHrs = hpd;
            const pudoLabor = pudoHrs * crewRate;

            const stdProdDays = Math.ceil(tier.std.days);
            const machineRental = stdProdDays * machinePerDay;
            const material = lf * matPerLF;

            // Standard-only render for mastic (has extra lines for P/U-D/O and machine rental)
            const el = document.getElementById('ma_output');
            let html = '';
            html += `<div class="output-row"><span class="lbl">Crew Size</span><span class="val">${tier.std.crew}</span></div>`;
            html += `<div class="output-row"><span class="lbl">Production Hours</span><span class="val">${tier.std.hours.toFixed(1)}</span></div>`;
            html += `<div class="output-row"><span class="lbl">Production Days</span><span class="val">${stdProdDays}</span></div>`;
            html += `<div class="output-row"><span class="lbl">Total Days (incl P/U & D/O)</span><span class="val">${stdProdDays + 1}</span></div>`;
            html += `<div class="output-divider"></div>`;
            html += `<div class="output-row cost"><span class="lbl">Labor & Equip (production)</span><span class="val">${fmt(tier.std.hours * crewRate)}</span></div>`;
            html += `<div class="output-row cost"><span class="lbl">Labor (pickup/dropoff)</span><span class="val">${fmt(pudoLabor)}</span></div>`;
            html += `<div class="output-row cost"><span class="lbl">Machine Rental (${stdProdDays} day${stdProdDays>1?'s':''})</span><span class="val">${fmt(machineRental)}</span></div>`;
            html += `<div class="output-row cost"><span class="lbl">Material</span><span class="val">${fmt(material)}</span></div>`;
            html += `<div class="output-row highlight"><span class="lbl">Total</span><span class="val">${fmt(tier.std.hours * crewRate + pudoLabor + machineRental + material)}</span></div>`;
            el.innerHTML = html;

            sumLabor.ma = tier.std.hours * crewRate + pudoLabor;
            sumMat.ma = material + machineRental;
            hbRows.push({ name: 'Mastic', tier, note: `+1 day P/U-D/O` });
        } else {
            renderTierTable('ma_output', null);
        }
    } else { renderTierTable('ma_output', null); }

    // === WHEEL STOPS ===
    if (isOn('en_wheelstop')) {
        const newQty = gv('ws_new');
        const resetQty = gv('ws_reset');
        const removeQty = gv('ws_remove');
        const prodPerDay = gv('prodWheelStop');
        const phases = Math.max(gv('ws_phases'), 1);
        const crew = gv('crewWsInstall');
        const totalQty = newQty + resetQty + removeQty;

        if (totalQty > 0) {
            // Wheel stops: one crew does all three, calculate combined
            const tier = calcThreeTier(totalQty, prodPerDay, hpd, phases, minHrs, crew);

            // Proportional hours per sub-type based on standard hours
            const totalProdHrs = totalQty > 0 ? (totalQty / prodPerDay) * hpd : 0;
            const newFrac = newQty / totalQty;
            const resetFrac = resetQty / totalQty;
            const removeFrac = removeQty / totalQty;

            const newLabor = tier.std.hours * newFrac * gv('rateWsInstall');
            const resetLabor = tier.std.hours * resetFrac * gv('rateWsReset');
            const removeLabor = tier.std.hours * removeFrac * gv('rateWsRemove');
            const totalLabor = newLabor + resetLabor + removeLabor;

            const newMat = newQty * gv('matWsNew');
            const resetMat = resetQty * gv('matWsPin');
            const removeMat = removeQty * gv('matWsDispose');
            const totalMatCost = newMat + resetMat + removeMat;

            // Blended rate for tier display
            const blendedRate = totalLabor / tier.std.hours;

            renderTierTable('ws_output', tier, blendedRate, totalMatCost);
            sumLabor.ws = totalLabor;
            sumMat.ws = totalMatCost;
            hbRows.push({ name: 'Wheel Stops', tier });
        } else {
            renderTierTable('ws_output', null);
        }
    } else { renderTierTable('ws_output', null); }

    // === SIGNS ===
    if (isOn('en_sign')) {
        const postQty = gv('sg_post');
        const bollQty = gv('sg_bollard');
        const crewRate = gv('rateSign');
        const phases = Math.max(gv('sg_phases'), 1);
        const crew = gv('crewSign');
        const prodPost = gv('prodSignPost');
        const prodBoll = gv('prodSignBollard');

        // Combined: convert to equivalent units at post rate
        const equivQty = postQty + (bollQty * (prodPost / prodBoll));
        const matCost = (postQty * gv('matSignSmall')) + (bollQty * (gv('matSignLarge') + gv('matBollard')));

        if (equivQty > 0) {
            const tier = calcThreeTier(equivQty, prodPost, hpd, phases, minHrs, crew);
            renderTierTable('sg_output', tier, crewRate, matCost);
            sumLabor.sg = tier.std.hours * crewRate;
            sumMat.sg = matCost;
            hbRows.push({ name: 'Signs', tier });
        } else {
            renderTierTable('sg_output', null);
        }
    } else { renderTierTable('sg_output', null); }

    // === BOLLARD REPLACEMENT ===
    if (isOn('en_bollard')) {
        const qty = gv('bo_qty');
        const crewRate = gv('rateBollard');
        const prod = gv('prodBollard');
        const phases = Math.max(gv('bo_phases'), 1);
        const crew = gv('crewBollard');
        const matCost = qty * gv('matBollard');
        const tier = calcThreeTier(qty, prod, hpd, phases, minHrs, crew);
        renderTierTable('bo_output', tier, crewRate, matCost);
        if (tier) {
            sumLabor.bo = tier.std.hours * crewRate;
            sumMat.bo = matCost;
            hbRows.push({ name: 'Bollards', tier });
        }
    } else { renderTierTable('bo_output', null); }

    // === RUBBER SPEED BUMPS ===
    if (isOn('en_speedbump')) {
        const qty = gv('sb_qty');
        const crewRate = gv('rateSpeedBump');
        const prod = gv('prodSpeedBump');
        const phases = Math.max(gv('sb_phases'), 1);
        const crew = gv('crewSpeedBump');
        const matCost = qty * gv('matSpeedBump');
        const tier = calcThreeTier(qty, prod, hpd, phases, minHrs, crew);
        renderTierTable('sb_output', tier, crewRate, matCost);
        if (tier) {
            sumLabor.sb = tier.std.hours * crewRate;
            sumMat.sb = matCost;
            hbRows.push({ name: 'Rubber Speed Bumps', tier });
        }
    } else { renderTierTable('sb_output', null); }

    // === SPEED HUMPS ===
    if (isOn('en_speedhump')) {
        const qty = gv('sh_qty');
        const crewRate = gv('rateSpeedHump');
        const prod = gv('prodSpeedHump');
        const phases = Math.max(gv('sh_phases'), 1);
        const crew = gv('crewSpeedHump');
        const tonsPerHump = 2.13;
        const tons = qty > 0 ? Math.ceil(qty * tonsPerHump) : 0;
        const matCost = tons * asphaltPrice;
        sv('sh_tons', tons);
        const tier = calcThreeTier(qty, prod, hpd, phases, minHrs, crew);
        renderTierTable('sh_output', tier, crewRate, matCost);
        if (tier) {
            sumLabor.sh = tier.std.hours * crewRate;
            sumMat.sh = matCost;
            hbRows.push({ name: 'Speed Humps', tier });
        }
    } else {
        sv('sh_tons', '0');
        renderTierTable('sh_output', null);
    }

    // === INLET REPAIR ===
    if (isOn('en_inlet')) {
        const repairQty = gv('in_repair');
        const reconQty = gv('in_recon');
        const castingQty = gv('in_casting');
        const crewRate = gv('rateInlet');
        const phases = Math.max(gv('in_phases'), 1);
        const crew = gv('crewInlet');

        // Inlet repair: 6 units/day (converted from old 4 hrs/unit)
        const repairProd = gv('prodInletRepair'); // units/day
        const hrsPerRecon = gv('prodInletRecon'); // hrs/unit (still scope-dependent)

        const totalQty = repairQty + reconQty;
        if (totalQty > 0) {
            // Convert to total production hours
            const repairHrs = repairQty > 0 ? (repairQty / repairProd) * hpd : 0;
            const reconHrs = reconQty * hrsPerRecon;
            const combinedHrs = repairHrs + reconHrs;
            const equivDailyRate = combinedHrs > 0 ? (totalQty / (combinedHrs / hpd)) : repairProd;

            // Use combined hours approach with phasing
            const prodDays = combinedHrs / hpd;
            const actualDays = Math.max(prodDays, phases);
            const stdHrs = Math.max(actualDays * hpd, minHrs);

            // Conservative: 80% production
            const consDays = Math.max(combinedHrs / (hpd * 0.80), phases);
            const consHrs = Math.max(consDays * hpd, minHrs);

            // Aggressive: 120% production
            const aggDays = Math.max(combinedHrs / (hpd * 1.20), phases);
            const aggHrs = Math.max(aggDays * hpd, minHrs);

            const tier = {
                cons: { crew: crew, hours: consHrs, days: Math.ceil(consDays) },
                std:  { crew: crew, hours: stdHrs, days: Math.ceil(actualDays) },
                agg:  { crew: crew, hours: aggHrs, days: Math.ceil(aggDays) }
            };

            const blockCost = totalQty * gv('matBlock');
            const castingCost = castingQty * gv('matCasting');
            const totalMat = blockCost + castingCost;

            renderTierTable('in_output', tier, crewRate, totalMat);
            sumLabor.in = stdHrs * crewRate;
            sumMat.in = totalMat;
            hbRows.push({ name: 'Inlet Repair', tier });
        } else {
            renderTierTable('in_output', null);
        }
    } else { renderTierTable('in_output', null); }

    // === PAINT REMOVAL ===
    if (isOn('en_paintremoval')) {
        const lf = gv('pr_lf');
        const crewRate = gv('rateStriping'); // same crew
        const prod = gv('prodPaintRemoval');
        const rentalPerDay = gv('matPaintRemoval');
        const phases = Math.max(gv('pr_phases'), 1);
        const crew = gv('crewStriping');

        if (lf > 0) {
            const tier = calcThreeTier(lf, prod, hpd, phases, minHrs, crew);
            const rentalDays = Math.ceil(tier.std.days);
            const rental = rentalDays * rentalPerDay;

            renderTierTable('pr_output', tier, crewRate, 0, rental);
            sumLabor.pr = tier.std.hours * crewRate;
            sumMat.pr = rental;
            hbRows.push({ name: 'Paint Removal', tier, note: `Grinder: machine bucket (concurrent with striping)` });
        } else {
            renderTierTable('pr_output', null);
        }
    } else { renderTierTable('pr_output', null); }

    // === ESTIMATE SUMMARY TABLE ===
    const hbBody = document.getElementById('hbBody');
    if (hbRows.length === 0) {
        hbBody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--text-muted); padding:1rem;">Enter quantities above to see estimate data</td></tr>';
    } else {
        let html = '';
        let totConsHrs = 0, totConsDays = 0, totStdHrs = 0, totStdDays = 0, totAggHrs = 0, totAggDays = 0;

        hbRows.forEach(row => {
            const { cons, std, agg } = row.tier;
            totConsHrs += cons.hours; totConsDays += cons.days;
            totStdHrs += std.hours; totStdDays += std.days;
            totAggHrs += agg.hours; totAggDays += agg.days;

            html += `<tr>
                <td>${row.name}${row.note ? '<br><span style="font-size:0.6rem;color:var(--text-muted);font-family:IBM Plex Sans,sans-serif;font-weight:400;">' + row.note + '</span>' : ''}</td>
                <td>${std.crew}</td>
                <td class="hb-cons">${cons.hours.toFixed(1)}</td><td class="hb-cons">${cons.days}</td>
                <td class="hb-std">${std.hours.toFixed(1)}</td><td class="hb-std">${std.days}</td>
                <td class="hb-agg">${agg.hours.toFixed(1)}</td><td class="hb-agg">${agg.days}</td>
            </tr>`;
        });

        // Totals row
        html += `<tr style="border-top:2px solid var(--border-highlight); font-weight:700;">
            <td style="color:var(--text-primary);">TOTAL JOB</td>
            <td>-</td>
            <td class="hb-cons">${totConsHrs.toFixed(1)}</td><td class="hb-cons">${totConsDays}</td>
            <td class="hb-std">${totStdHrs.toFixed(1)}</td><td class="hb-std">${totStdDays}</td>
            <td class="hb-agg">${totAggHrs.toFixed(1)}</td><td class="hb-agg">${totAggDays}</td>
        </tr>`;

        hbBody.innerHTML = html;
    }

    // === COMBINED SUMMARY ===
    let totalLabor = 0, totalMat = 0;
    workTypes.forEach(k => {
        sv('sum_' + k, fmt(sumLabor[k]));
        sv('summ_' + k, fmt(sumMat[k]));
        totalLabor += sumLabor[k];
        totalMat += sumMat[k];
        const laborRow = document.getElementById('sum_' + k + '_row');
        const matRow = document.getElementById('summ_' + k + '_row');
        if (laborRow) laborRow.style.display = sumLabor[k] > 0 ? 'flex' : 'none';
        if (matRow) matRow.style.display = sumMat[k] > 0 ? 'flex' : 'none';
    });

    sv('sum_laborTotal', fmt(totalLabor));
    sv('sum_matTotal', fmt(totalMat));

    const directCost = totalLabor + totalMat;
    const markup = gv('markupPercent') || gv('markupPercent2');
    const markupAmt = directCost * (markup / 100);
    sv('directCostTotal', fmt(directCost));
    sv('markupAmount', fmt(markupAmt));
    sv('bidPrice', fmt(directCost + markupAmt));
}

// ===== SAVE / LOAD / RESET =====
function saveRates() {
    const ids = [
        'hoursPerDay','asphaltPrice','baseAsphaltPrice','dgaPrice','markupPercent',
        'rateCrackFill','rateSealcoat','rateStriping','rateAsphaltSmall','rateAsphaltLarge',
        'rateWsInstall','rateWsReset','rateWsRemove','rateSpeedBump','rateBollard','rateSign',
        'rateMastic','rateInlet','rateSpeedHump',
        'matCrackFill','matSealcoat','mat4Line','mat6Line','mat12Line','mat24Line',
        'matArrow','matHC','matStencil','matCurb','matWsNew','matWsPin','matWsDispose',
        'matSpeedBump','matBollard','matSignSmall','matSignLarge','matMastic','matMasticMachine',
        'matBlock','matCasting','matPaintRemoval',
        'prodCrackFill','prodSealcoat','prod4Line','prod6Line','prod12Line','prod24Bar',
        'prodHC','prodArrow','prodStencil','prodCurb','prodAsphaltRepair','prodWheelStop',
        'prodSpeedBump','prodBollard','prodSignPost','prodSignBollard','prodMastic',
        'prodInletRepair','prodInletRecon','prodSpeedHump','prodPaintRemoval',
        'crewCrackFill','crewSealcoat','crewStriping','crewAsphaltSmall','crewAsphaltLarge',
        'crewWsInstall','crewSpeedBump','crewBollard','crewSign','crewMastic','crewInlet','crewSpeedHump'
    ];
    const data = { _version: CALC_VERSION };
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) data[id] = el.value;
    });
    localStorage.setItem('maintCalcRates', JSON.stringify(data));
    showToast('Rates saved locally!');
}

function loadRates() {
    const saved = localStorage.getItem('maintCalcRates');
    if (saved) {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(key => {
            if (key === '_version') return;
            const el = document.getElementById(key);
            if (el) el.value = data[key];
        });
        showToast('Rates loaded!');
        calculateAll();
    } else {
        showToast('No saved rates found');
    }
}

function clearSavedRates() {
    localStorage.removeItem('maintCalcRates');
    showToast('Saved rates cleared');
}

function resetForm() {
    const quantityInputs = [
        'cf_lf','sc_sf',
        'st_4line','st_6line','st_12line','st_24bar','st_hc','st_arrow','st_stencil','st_curb',
        'ar_sf','ma_lf',
        'ws_new','ws_reset','ws_remove',
        'sg_post','sg_bollard',
        'bo_qty','sb_qty','sh_qty',
        'in_repair','in_recon','in_casting',
        'pr_lf'
    ];
    const phaseInputs = [
        'cf_phases','sc_phases','st_phases','ar_phases','ma_phases',
        'ws_phases','sg_phases','bo_phases','sb_phases','sh_phases','in_phases','pr_phases'
    ];
    quantityInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    phaseInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '1';
    });
    document.getElementById('projectName').value = '';
    document.getElementById('ar_depth').selectedIndex = 0;
    document.getElementById('sh_type').selectedIndex = 0;
    calculateAll();
    showToast('Form reset');
}

// ===== EXPORT =====
function exportResults() {
    const proj = document.getElementById('projectName').value || 'Unnamed Project';
    const hpd = gv('hoursPerDay');
    const markup = gv('markupPercent') || gv('markupPercent2');

    let lines = [];
    lines.push('MAINTENANCE DIVISION ESTIMATE (v3.0 Three-Tier)');
    lines.push('='.repeat(60));
    lines.push('Project: ' + proj);
    lines.push('Generated: ' + new Date().toLocaleString());
    lines.push('Hours/Day: ' + hpd);
    lines.push('');

    // Export summary table
    const hbBody = document.getElementById('hbBody');
    const rows = hbBody.querySelectorAll('tr');
    if (rows.length > 0 && !rows[0].textContent.includes('Enter quantities')) {
        lines.push('ESTIMATE SUMMARY (THREE-TIER)');
        lines.push('-'.repeat(60));
        lines.push(padR('Activity', 22) + padR('Crew', 6) + padR('Cons Hrs', 10) + padR('Std Hrs', 10) + padR('Agg Hrs', 10));
        lines.push('-'.repeat(60));
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const name = cells[0].textContent.split('\n')[0].trim();
                lines.push(
                    padR(name, 22) +
                    padR(cells[1].textContent, 6) +
                    padR(cells[2].textContent + 'h', 10) +
                    padR(cells[4].textContent + 'h', 10) +
                    padR(cells[6].textContent + 'h', 10)
                );
            }
        });
        lines.push('');
    }

    lines.push('='.repeat(60));
    lines.push('COST SUMMARY (Standard Tier)');
    lines.push('='.repeat(60));
    lines.push('Labor & Equipment: ' + document.getElementById('sum_laborTotal').textContent);
    lines.push('Materials: ' + document.getElementById('sum_matTotal').textContent);
    lines.push('Direct Cost: ' + document.getElementById('directCostTotal').textContent);
    lines.push('Markup (' + markup + '%): ' + document.getElementById('markupAmount').textContent);
    lines.push('BID PRICE: ' + document.getElementById('bidPrice').textContent);

    const text = lines.join('\n');
    navigator.clipboard.writeText(text).then(() => {
        showToast('Results copied to clipboard!');
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Results copied to clipboard!');
    });
}

function padR(str, len) {
    str = String(str);
    return str.length >= len ? str : str + ' '.repeat(len - str.length);
}

// ===== INIT =====
const CALC_VERSION = '3.0';

document.addEventListener('DOMContentLoaded', function() {
    const saved = localStorage.getItem('maintCalcRates');
    if (saved) {
        const data = JSON.parse(saved);
        if (data._version !== CALC_VERSION) {
            localStorage.removeItem('maintCalcRates');
            showToast('Rates reset to v' + CALC_VERSION + ' defaults (previous version cleared)');
        } else {
            Object.keys(data).forEach(key => {
                if (key === '_version') return;
                const el = document.getElementById(key);
                if (el) el.value = data[key];
            });
        }
    }
    calculateAll();
});
</script>
</body>
</html>
